<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hadoop,Java,Hive," />





  <link rel="alternate" href="/atom.xml" title="Wei.Cao" type="application/atom+xml" />






<meta name="description" content="Hive基本概念Hive简介什么是Hive Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。  为什么使用Hive 直接使用hadoop所面临的问题  人员学习成本太高  项目周期要求太短  MapReduce实现复杂查询逻辑开发难度太大    为什么要使用Hive  操作接口采用类SQL语法，提供快速开发的能力。  避免了去写Map">
<meta name="keywords" content="Hadoop,Java,Hive">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive学习">
<meta property="og:url" content="http://yoursite.com/2017/06/22/Hive学习/index.html">
<meta property="og:site_name" content="Wei.Cao">
<meta property="og:description" content="Hive基本概念Hive简介什么是Hive Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。  为什么使用Hive 直接使用hadoop所面临的问题  人员学习成本太高  项目周期要求太短  MapReduce实现复杂查询逻辑开发难度太大    为什么要使用Hive  操作接口采用类SQL语法，提供快速开发的能力。  避免了去写Map">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/FA05HJim9d.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/djd85kK7B2.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/0B7iIFIAKJ.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/h2i50046k3.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/0h5b2g1EHC.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/CmJk3Kc7bg.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/gAL46KmJJE.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/imCB8GBe6k.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/J3bGK0fm5k.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/h33Fb7KDcE.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/8iG3e0BG9e.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/7aclDe2CgH.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/ecF4b3BehL.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/2d4b0GEK2A.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/ikDb0e79AC.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/kiLm8Db4f1.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/1DGDk2fi1h.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/4GC6mL2Gg6.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/0F3GKEa5L2.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/cadmEgHi7D.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/4fKFECcLAC.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/KIkdBcAL2i.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/AmfIC22cJ3.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/BKaDG17jGE.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/Cic2jbAFD9.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/4DEbE8ChaE.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/35EDK1Cm5i.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/DIg4Ca6B5d.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/lELDEe7cf7.png?imageslim">
<meta property="og:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/HD7BiB7H6d.png?imageslim">
<meta property="og:updated_time" content="2018-03-08T11:43:15.374Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hive学习">
<meta name="twitter:description" content="Hive基本概念Hive简介什么是Hive Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。  为什么使用Hive 直接使用hadoop所面临的问题  人员学习成本太高  项目周期要求太短  MapReduce实现复杂查询逻辑开发难度太大    为什么要使用Hive  操作接口采用类SQL语法，提供快速开发的能力。  避免了去写Map">
<meta name="twitter:image" content="http://ou9crezlk.bkt.clouddn.com/blog/180307/FA05HJim9d.png?imageslim">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/06/22/Hive学习/"/>





  <title>Hive学习 | Wei.Cao</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ad8fac4ab530dc35351b752a97b89b03";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wei.Cao</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-board">
          <a href="/board/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/22/Hive学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wei.Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/596cd3e8d520e.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei.Cao">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hive学习</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-22T11:50:35+08:00">
                2017-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/22/Hive学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2017/06/22/Hive学习/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Hive基本概念"><a href="#Hive基本概念" class="headerlink" title="Hive基本概念"></a>Hive基本概念</h2><h3 id="Hive简介"><a href="#Hive简介" class="headerlink" title="Hive简介"></a>Hive简介</h3><h4 id="什么是Hive"><a href="#什么是Hive" class="headerlink" title="什么是Hive"></a>什么是Hive</h4><ul>
<li>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。</li>
</ul>
<h4 id="为什么使用Hive"><a href="#为什么使用Hive" class="headerlink" title="为什么使用Hive"></a>为什么使用Hive</h4><ul>
<li>直接使用hadoop所面临的问题 <ul>
<li>人员学习成本太高 </li>
<li>项目周期要求太短 </li>
<li>MapReduce实现复杂查询逻辑开发难度太大 </li>
</ul>
</li>
<li>为什么要使用Hive <ul>
<li>操作接口采用类SQL语法，提供快速开发的能力。 </li>
<li>避免了去写MapReduce，减少开发人员的学习成本。 </li>
<li>扩展功能很方便。</li>
</ul>
</li>
</ul>
<h4 id="Hive的特点"><a href="#Hive的特点" class="headerlink" title="Hive的特点"></a>Hive的特点</h4><ul>
<li>可扩展 <ul>
<li>Hive可以自由的扩展集群的规模，一般情况下不需要重启服务。</li>
</ul>
</li>
<li>延展性 <ul>
<li>Hive支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。</li>
</ul>
</li>
<li>容错 <ul>
<li>良好的容错性，节点出现问题SQL仍可完成执行。</li>
</ul>
</li>
</ul>
<h3 id="Hive架构"><a href="#Hive架构" class="headerlink" title="Hive架构"></a>Hive架构</h3><h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/FA05HJim9d.png?imageslim" alt="mark"></p>
<ul>
<li>Jobtracker是hadoop1.x中的组件，它的功能相当于： Resourcemanager+AppMaster</li>
<li>TaskTracker 相当于：  Nodemanager  +  yarnchild</li>
</ul>
<h4 id="基本组成"><a href="#基本组成" class="headerlink" title="基本组成"></a>基本组成</h4><ul>
<li>用户接口：包括 CLI、JDBC/ODBC、WebGUI。</li>
<li>元数据存储：通常是存储在关系数据库如 mysql , derby中。</li>
<li>解释器、编译器、优化器、执行器。</li>
</ul>
<h4 id="各组件的基本功能"><a href="#各组件的基本功能" class="headerlink" title="各组件的基本功能"></a>各组件的基本功能</h4><ul>
<li>用户接口主要由三个：CLI、JDBC/ODBC和WebGUI。其中，CLI为shell命令行；JDBC/ODBC是Hive的JAVA实现，与传统数据库JDBC类似；WebGUI是通过浏览器访问Hive。</li>
<li>元数据存储：Hive 将元数据存储在数据库中。Hive 中的元数据包括表的名字，表的列和分区及其属性，表的属性（是否为外部表等），表的数据所在目录等。</li>
<li>解释器、编译器、优化器完成 HQL 查询语句从词法分析、语法分析、编译、优化以及查询计划的生成。生成的查询计划存储在 HDFS 中，并在随后有 MapReduce 调用执行。</li>
</ul>
<h3 id="Hive与Hadoop的关系"><a href="#Hive与Hadoop的关系" class="headerlink" title="Hive与Hadoop的关系"></a>Hive与Hadoop的关系</h3><ul>
<li>Hive利用HDFS存储数据，利用MapReduce查询数据</li>
<li><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/djd85kK7B2.png?imageslim" alt="mark"></li>
</ul>
<h3 id="Hive与传统数据库对比"><a href="#Hive与传统数据库对比" class="headerlink" title="Hive与传统数据库对比"></a>Hive与传统数据库对比</h3><p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/0B7iIFIAKJ.png?imageslim" alt="mark"></p>
<ul>
<li>总结：hive具有sql数据库的外表，但应用场景完全不同，hive只适合用来做批量数据统计分析</li>
</ul>
<h3 id="Hive的数据存储"><a href="#Hive的数据存储" class="headerlink" title="Hive的数据存储"></a>Hive的数据存储</h3><ol>
<li>Hive中所有的数据都存储在 HDFS 中，没有专门的数据存储格式（可支持Text，SequenceFile，ParquetFile，RCFILE等）</li>
<li>只需要在创建表的时候告诉 Hive 数据中的列分隔符和行分隔符，Hive 就可以解析数据。</li>
<li>Hive 中包含以下数据模型：DB、Table，External Table，Partition，Bucket。<ul>
<li>db：在hdfs中表现为${hive.metastore.warehouse.dir}目录下一个文件夹</li>
<li>table：在hdfs中表现所属db目录下一个文件夹</li>
<li>external table：与table类似，不过其数据存放位置可以在任意指定路径</li>
<li>partition：在hdfs中表现为table目录下的子目录</li>
<li>bucket：在hdfs中表现为同一个表目录下根据hash散列之后的多个文件</li>
</ul>
</li>
</ol>
<h2 id="Hive基本操作"><a href="#Hive基本操作" class="headerlink" title="Hive基本操作"></a>Hive基本操作</h2><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><h4 id="Hive交互shell"><a href="#Hive交互shell" class="headerlink" title="Hive交互shell"></a>Hive交互shell</h4><ul>
<li><code>bin/hive</code></li>
</ul>
<h4 id="Hive-thrift服务"><a href="#Hive-thrift服务" class="headerlink" title="Hive thrift服务"></a>Hive thrift服务</h4><p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/h2i50046k3.png?imageslim" alt="mark"></p>
<ul>
<li>启动方式，（假如是在hadoop01上）：</li>
<li>启动为前台：<code>bin/hiveserver2</code></li>
<li>启动为后台：<code>nohup bin/hiveserver2 1&gt;/var/log/hiveserver.log 2&gt;/var/log/hiveserver.err &amp;</code></li>
<li>启动成功后，可以在别的节点上用beeline去连接<ul>
<li>方式（1）<ul>
<li><code>hive/bin/beeline</code>  回车，进入beeline的命令界面</li>
<li>输入命令连接hiveserver2</li>
<li><code>beeline&gt; !connect jdbc:hive2//mini1:10000</code></li>
<li>（hadoop01是hiveserver2所启动的那台主机名，端口默认是10000）</li>
</ul>
</li>
<li>方式（2）<ul>
<li>或者启动就连接：</li>
<li><code>bin/beeline -u jdbc:hive2://mini1:10000 -n hadoop</code></li>
</ul>
</li>
</ul>
</li>
<li>接下来就可以做正常sql查询了</li>
</ul>
<h4 id="Hive命令"><a href="#Hive命令" class="headerlink" title="Hive命令"></a>Hive命令</h4><ul>
<li>命令执行 <ul>
<li><code>hive  -e  ‘sql’</code></li>
</ul>
</li>
</ul>
<h3 id="DDL操作"><a href="#DDL操作" class="headerlink" title="DDL操作"></a>DDL操作</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><h5 id="建表语法"><a href="#建表语法" class="headerlink" title="建表语法"></a>建表语法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name </span><br><span class="line">   [(col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line">   [COMMENT table_comment] </span><br><span class="line">   [PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line">   [CLUSTERED BY (col_name, col_name, ...) </span><br><span class="line">   [SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS] </span><br><span class="line">   [ROW FORMAT row_format] </span><br><span class="line">   [STORED AS file_format] </span><br><span class="line">   [LOCATION hdfs_path]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>说明：</p>
<ol>
<li><p><code>CREATE TABLE</code> 创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用 <code>IF NOT EXISTS</code> 选项来忽略这个异常。</p>
</li>
<li><p><code>EXTERNAL</code>关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径（LOCATION），Hive 创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ROW FORMAT </span><br><span class="line">DELIMITED [FIELDS TERMINATED BY char] [COLLECTION ITEMS TERMINATED BY char] </span><br><span class="line">        [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char] </span><br><span class="line">   | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</span><br><span class="line">用户在建表的时候可以自定义 SerDe 或者使用自带的 SerDe。如果没有指定 ROW FORMAT 或者 ROW FORMAT DELIMITED，将会使用自带的 SerDe。在建表的时候，用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的 SerDe，Hive通过 SerDe 确定表的具体的列的数据。</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">STORED AS </span><br><span class="line">SEQUENCEFILE|TEXTFILE|RCFILE</span><br><span class="line">如果文件数据是纯文本，可以使用 STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>CLUSTERED BY</code></p>
<ol>
<li>对于每一个表（table）或者分区， Hive可以进一步组织成桶，也就是说桶是更为细粒度的数据范围划分。Hive也是 针对某一列进行桶的组织。Hive采用对列值哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中。<br>把表（或者分区）组织成桶（Bucket）有两个理由：<ol>
<li>获得更高的查询处理效率。桶为表加上了额外的结构，Hive 在处理有些查询时能利用这个结构。具体而言，连接两个在（包含连接列的）相同列上划分了桶的表，可以使用 Map 端连接 （Map-side join）高效的实现。比如JOIN操作。对于JOIN操作两个表有一个相同的列，如果对这两个表都进行了桶操作。那么将保存相同列值的桶进行JOIN操作就可以，可以大大较少JOIN的数据量。</li>
<li>使取样（sampling）更高效。在处理大规模数据集时，在开发和修改查询的阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ul>
<h5 id="具体实例"><a href="#具体实例" class="headerlink" title="具体实例"></a>具体实例</h5><ol>
<li><p>创建内部表mytable。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/0h5b2g1EHC.png?imageslim" alt="mark"></p>
</li>
<li><p>创建外部表pageview。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/CmJk3Kc7bg.png?imageslim" alt="mark"></p>
</li>
<li><p>创建分区表invites。</p>
<ul>
<li><code>create table student_p(Sno int,Sname string,Sex string,Sage int,Sdept string) partitioned by(part string) row format delimited fields terminated by &#39;,&#39;stored as textfile;</code></li>
</ul>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/gAL46KmJJE.png?imageslim" alt="mark"></p>
<p> 、    创建带桶的表student。</p>
</li>
</ol>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/imCB8GBe6k.png?imageslim" alt="mark"></p>
<h4 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h4><h5 id="增加-删除分区"><a href="#增加-删除分区" class="headerlink" title="增加/删除分区"></a>增加/删除分区</h5><ul>
<li><p>语法结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name ADD [IF NOT EXISTS] partition_spec [ LOCATION &apos;location1&apos; ] partition_spec [ LOCATION &apos;location2&apos; ] ...</span><br><span class="line">partition_spec:</span><br><span class="line">: PARTITION (partition_col = partition_col_value, partition_col = partiton_col_value, ...)</span><br><span class="line">ALTER TABLE table_name DROP partition_spec, partition_spec,...</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体实例</p>
<ul>
<li><p><code>alter table student_p add partition(part=&#39;a&#39;) partition(part=&#39;b&#39;);</code></p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/J3bGK0fm5k.png?imageslim" alt="mark"></p>
</li>
</ul>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/h33Fb7KDcE.png?imageslim" alt="mark"></p>
</li>
</ul>
<h5 id="重命名表"><a href="#重命名表" class="headerlink" title="重命名表"></a>重命名表</h5><ul>
<li>语法结构<ul>
<li><code>ALTER TABLE table_name RENAME TO new_table_name</code></li>
</ul>
</li>
<li>具体实例</li>
</ul>
<h5 id="增加-更新列"><a href="#增加-更新列" class="headerlink" title="增加/更新列"></a>增加/更新列</h5><ul>
<li><p>语法结构</p>
<ul>
<li><code>ALTER TABLE table_name ADD|REPLACE COLUMNS (col_name data_type [COMMENT col_comment], ...)</code></li>
<li>注：ADD是代表新增一字段，字段位置在所有列后面(partition列前)，REPLACE则是表示替换表中所有字段。</li>
<li><code>ALTER TABLE table_name CHANGE [COLUMN] col_old_name col_new_name column_type [COMMENT col_comment][FIRST|AFTER column_name]</code></li>
</ul>
</li>
<li><p>具体实例</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/8iG3e0BG9e.png?imageslim" alt="mark"></p>
</li>
</ul>
<h4 id="显示命令"><a href="#显示命令" class="headerlink" title="显示命令"></a>显示命令</h4><ul>
<li>show tables</li>
<li><p>show databases</p>
</li>
<li><p>show partitions</p>
</li>
<li>show functions</li>
<li>desc extended t_name;</li>
<li>desc formatted table_name;</li>
</ul>
<h3 id="DML操作"><a href="#DML操作" class="headerlink" title="DML操作"></a>DML操作</h3><h4 id="Load"><a href="#Load" class="headerlink" title="Load"></a>Load</h4><ul>
<li><p>语法结构</p>
<ul>
<li><code>LOAD DATA [LOCAL] INPATH &#39;filepath&#39; [OVERWRITE] INTO TABLE tablename [PARTITION (partcol1=val1, partcol2=val2 ...)]</code></li>
</ul>
</li>
<li><p>说明：</p>
<ol>
<li>Load 操作只是单纯的复制/移动操作，将数据文件移动到 Hive 表对应的位置。</li>
<li>filepath：<ul>
<li>相对路径，例如：<code>project/data1</code></li>
<li>绝对路径，例如：<code>/user/hive/project/data1</code> </li>
<li>包含模式的完整 URI，列如：</li>
<li><code>hdfs://namenode:9000/user/hive/project/data1</code></li>
</ul>
</li>
<li>LOCAL关键字<ul>
<li>如果指定了 LOCAL， load 命令会去查找本地文件系统中的 filepath。</li>
<li>如果没有指定 LOCAL 关键字，则根据inpath中的uri查找文件</li>
</ul>
</li>
<li>OVERWRITE 关键字<ul>
<li>如果使用了 OVERWRITE 关键字，则目标表（或者分区）中的内容会被删除，然后再将 filepath 指向的文件/目录中的内容添加到表<code>/</code>分区中。 </li>
<li>如果目标表（分区）已经有一个文件，并且文件名和 filepath 中的文件名冲突，那么现有的文件会被新文件所替代。 </li>
</ul>
</li>
</ol>
</li>
<li><p>具体实例</p>
<ol>
<li><p>加载相对路径数据。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/7aclDe2CgH.png?imageslim" alt="mark"></p>
</li>
<li><p>加载绝对路径数据。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/ecF4b3BehL.png?imageslim" alt="mark"></p>
</li>
<li><p>加载包含模式数据。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/2d4b0GEK2A.png?imageslim" alt="mark"></p>
</li>
<li><p>OVERWRITE关键字使用。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/ikDb0e79AC.png?imageslim" alt="mark"></p>
</li>
</ol>
</li>
</ul>
<h4 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h4><ul>
<li><p>将查询结果插入Hive表</p>
</li>
<li><p>语法结构</p>
<ul>
<li><code>INSERT OVERWRITE TABLE tablename1 [PARTITION (partcol1=val1, partcol2=val2 ...)] select_statement1 FROM from_statement</code></li>
</ul>
</li>
<li><p>Multiple inserts:</p>
<ul>
<li><code>FROM from_statement INSERT OVERWRITE TABLE tablename1 [PARTITION (partcol1=val1, partcol2=val2 ...)] select_statement1 [INSERT OVERWRITE TABLE tablename2 [PARTITION ...] select_statement2] ...</code></li>
</ul>
</li>
<li><p>Dynamic partition inserts:</p>
<ul>
<li><code>INSERT OVERWRITE TABLE tablename PARTITION (partcol1[=val1], partcol2[=val2] ...) select_statement FROM from_statement</code></li>
</ul>
</li>
<li><p>具体实例</p>
<ol>
<li><p>基本模式插入。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/kiLm8Db4f1.png?imageslim" alt="mark"></p>
</li>
<li><p>多插入模式。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/1DGDk2fi1h.png?imageslim" alt="mark"></p>
</li>
<li><p>自动分区模式。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/4GC6mL2Gg6.png?imageslim" alt="mark"></p>
</li>
</ol>
</li>
<li><p>导出表数据</p>
</li>
<li><p>语法结构</p>
<ul>
<li><code>INSERT OVERWRITE [LOCAL] DIRECTORY directory1 SELECT ... FROM ...</code></li>
</ul>
</li>
<li><p>multiple inserts:</p>
<ul>
<li><code>FROM from_statementINSERT OVERWRITE [LOCAL] DIRECTORY directory1 select_statement1[INSERT OVERWRITE [LOCAL] DIRECTORY directory2 select_statement2] ...</code></li>
</ul>
</li>
<li><p>具体实例</p>
<ul>
<li><p>导出文件到本地。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/0F3GKEa5L2.png?imageslim" alt="mark"></p>
</li>
<li><p>说明：</p>
</li>
<li><p>数据写入到文件系统时进行文本序列化，且每列用^A来区分，\n为换行符。用more命令查看时不容易看出分割符，可以使用: <code>sed -e &#39;s/\x01/|/g&#39; filename</code>来查看。</p>
</li>
</ul>
</li>
<li><p>导出数据到HDFS。</p>
</li>
</ul>
<h4 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h4><ul>
<li><p>基本的Select操作</p>
<ul>
<li>语法结构</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [ALL | <span class="keyword">DISTINCT</span>] select_expr, select_expr, ... </span><br><span class="line"><span class="keyword">FROM</span> table_reference</span><br><span class="line">[<span class="keyword">WHERE</span> where_condition] </span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> col_list [<span class="keyword">HAVING</span> condition]] </span><br><span class="line">[CLUSTER <span class="keyword">BY</span> col_list </span><br><span class="line">  | [<span class="keyword">DISTRIBUTE</span> <span class="keyword">BY</span> col_list] [<span class="keyword">SORT</span> <span class="keyword">BY</span>| <span class="keyword">ORDER</span> <span class="keyword">BY</span> col_list] </span><br><span class="line">] </span><br><span class="line">[<span class="keyword">LIMIT</span> <span class="built_in">number</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>注：</p>
<ol>
<li>order by 会对输入做全局排序，因此只有一个reducer，会导致当输入规模较大时，需要较长的计算时间。</li>
<li>sort by不是全局排序，其在数据进入reducer前完成排序。因此，如果用sort by进行排序，并且设置mapred.reduce.tasks&gt;1，则sort by只保证每个reducer的输出有序，不保证全局有序。</li>
<li>distribute by(字段)根据指定的字段将数据分到不同的reducer，且分发算法是hash散列。</li>
<li>Cluster by(字段) 除了具有Distribute by的功能外，还会对该字段进行排序。</li>
</ol>
</li>
<li><p>因此，如果分桶和sort字段是同一个时，此时，cluster by = distribute by + sort by</p>
</li>
<li><p>分桶表的作用：最大的作用是用来提高join操作的效率；</p>
</li>
<li><p>思考这个问题：<code>select a.id,a.name,b.addr from a join b on a.id = b.id;</code></p>
<ul>
<li>如果a表和b表已经是分桶表，而且分桶的字段是id字段</li>
<li>做这个join操作时，还需要全表做笛卡尔积吗？</li>
</ul>
</li>
</ul>
<ul>
<li><p>具体实例</p>
<ol>
<li><p>获取年龄大的3个学生。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/cadmEgHi7D.png?imageslim" alt="mark"></p>
</li>
<li><p>查询学生信息按年龄，降序排序。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/4fKFECcLAC.png?imageslim" alt="mark"></p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/KIkdBcAL2i.png?imageslim" alt="mark"></p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/AmfIC22cJ3.png?imageslim" alt="mark"></p>
</li>
<li><p>按学生名称汇总学生年龄。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/BKaDG17jGE.png?imageslim" alt="mark"></p>
</li>
</ol>
</li>
</ul>
<h3 id="Hive-Join"><a href="#Hive-Join" class="headerlink" title="Hive Join"></a>Hive Join</h3><ul>
<li><p>语法结构</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">join_table:</span><br><span class="line">  table_reference JOIN table_factor [join_condition]</span><br><span class="line">  | table_reference &#123;LEFT|RIGHT|FULL&#125; [OUTER] JOIN table_reference join_condition</span><br><span class="line">  | table_reference LEFT SEMI JOIN table_reference join_condition</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Hive 支持等值连接（equality joins）、外连接（outer joins）和（left/right joins）。</p>
</li>
<li><p>Hive 不支持非等值的连接，因为非等值连接非常难转化到 map/reduce 任务。</p>
</li>
<li><p>另外，Hive 支持多于 2 个表的连接。</p>
</li>
<li><p>写 join 查询时，需要注意几个关键点：</p>
</li>
</ul>
<h4 id="只支持等值join"><a href="#只支持等值join" class="headerlink" title="只支持等值join"></a>只支持等值join</h4><ul>
<li>例如： <code>SELECT a.* FROM a JOIN b ON (a.id = b.id) SELECT a.* FROM a JOIN b ON (a.id = b.id AND a.department = b.department)</code></li>
<li>是正确的，然而:</li>
<li><code>SELECT a.* FROM a JOIN b ON (a.id&gt;b.id)</code></li>
</ul>
<ul>
<li>是错误的。</li>
</ul>
<h4 id="可以-join-多于-2-个表。"><a href="#可以-join-多于-2-个表。" class="headerlink" title="可以 join 多于 2 个表。"></a>可以 join 多于 2 个表。</h4><ul>
<li>例如:</li>
<li><code>SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key2)</code></li>
<li>如果join中多个表的 join key 是同一个，则 join 会被转化为单个 map/reduce 任务，例如：<ul>
<li><code>SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key1)</code></li>
</ul>
</li>
<li>被转化为单个 map/reduce 任务，因为 join 中只使用了 b.key1 作为 join key。</li>
<li><code>SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key2)</code><ul>
<li>而这一 join 被转化为 2 个 map/reduce 任务。因为 b.key1 用于第一次 join 条件，而 b.key2 用于第二次 join。</li>
</ul>
</li>
</ul>
<h4 id="join-时，每次-map-reduce-任务的逻辑："><a href="#join-时，每次-map-reduce-任务的逻辑：" class="headerlink" title="join 时，每次 map/reduce 任务的逻辑："></a>join 时，每次 map/reduce 任务的逻辑：</h4><ul>
<li>reducer 会缓存 join 序列中除了最后一个表的所有表的记录，再通过最后一个表将结果序列化到文件系统。这一实现有助于在 reduce 端减少内存的使用量。实践中，应该把最大的那个表写在最后（否则会因为缓存浪费大量内存）。例如：<ul>
<li><code>SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key1)</code></li>
</ul>
</li>
<li>所有表都使用同一个 join key（使用 1 次 map/reduce 任务计算）。Reduce 端会缓存 a 表和 b 表的记录，然后每次取得一个 c 表的记录就计算一次 join 结果，类似的还有：</li>
<li><code>SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key2)</code></li>
<li>这里用了 2 次 map/reduce 任务。第一次缓存 a 表，用 b 表序列化；第二次缓存第一次 map/reduce 任务的结果，然后用 c 表序列化。</li>
</ul>
<h4 id="LEFT，RIGHT-和-FULL-OUTER-关键字用于处理-join-中空记录的情况"><a href="#LEFT，RIGHT-和-FULL-OUTER-关键字用于处理-join-中空记录的情况" class="headerlink" title="LEFT，RIGHT 和 FULL OUTER 关键字用于处理 join 中空记录的情况"></a>LEFT，RIGHT 和 FULL OUTER 关键字用于处理 join 中空记录的情况</h4><ul>
<li><p>例如：</p>
<ul>
<li><code>SELECT a.val, b.val FROM a LEFT OUTER  JOIN b ON (a.key=b.key)</code></li>
</ul>
</li>
<li><p>对应所有 a 表中的记录都有一条记录输出。输出的结果应该是 a.val, b.val，当 a.key=b.key 时，而当 b.key 中找不到等值的 a.key 记录时也会输出:</p>
<ul>
<li><code>a.val, NULL</code></li>
</ul>
</li>
<li><p>所以 a 表中的所有记录都被保留了；</p>
<p><code>a RIGHT OUTER JOIN b</code>会保留所有 b 表的记录。</p>
</li>
</ul>
<h4 id="Join-发生在-WHERE-子句之前。"><a href="#Join-发生在-WHERE-子句之前。" class="headerlink" title="Join 发生在 WHERE 子句之前。"></a>Join 发生在 WHERE 子句之前。</h4><ul>
<li>如果你想限制 join 的输出，应该在 WHERE 子句中写过滤条件——或是在 join 子句中写。这里面一个容易混淆的问题是表分区的情况：<ul>
<li><code>SELECT a.val, b.val FROM a LEFT OUTER JOIN b ON (a.key=b.key) WHERE a.ds=&#39;2009-07-07&#39; AND b.ds=&#39;2009-07-07&#39;</code></li>
<li>会 join a 表到 b 表（OUTER JOIN），列出 a.val 和 b.val 的记录。WHERE 从句中可以使用其他列作为过滤条件。但是，如前所述，如果 b 表中找不到对应 a 表的记录，b 表的所有列都会列出 NULL，包括 ds 列。也就是说，join 会过滤 b 表中不能找到匹配 a 表 join key 的所有记录。这样的话，LEFT OUTER 就使得查询结果与 WHERE 子句无关了。解决的办法是在 OUTER JOIN 时使用以下语法：<ul>
<li><code>SELECT a.val, b.val FROM a LEFT OUTER JOIN b ON (a.key=b.key AND b.ds=&#39;2009-07-07&#39; ANDa.ds=&#39;2009-07-07&#39;)</code></li>
</ul>
</li>
<li>这一查询的结果是预先在 join 阶段过滤过的，所以不会存在上述问题。这一逻辑也可以应用于 RIGHT 和 FULL 类型的 join 中。</li>
</ul>
</li>
</ul>
<h4 id="Join-是不能交换位置的。"><a href="#Join-是不能交换位置的。" class="headerlink" title="Join 是不能交换位置的。"></a>Join 是不能交换位置的。</h4><ul>
<li><p>无论是 LEFT 还是 RIGHT join，都是左连接的。</p>
<ul>
<li><code>SELECT a.val1, a.val2, b.val, c.val FROM JOIN b ON (a.key = b.key)  LEFT OUTER JOIN c ON (a.key = c.key)</code></li>
</ul>
</li>
<li><p>先 join a 表到 b 表，丢弃掉所有 join key 中不匹配的记录，然后用这一中间结果和 c 表做 join。这一表述有一个不太明显的问题，就是当一个 key 在 a 表和 c 表都存在，但是 b 表中不存在的时候：整个记录在第一次 join，即 a JOIN b 的时候都被丢掉了（包括a.val1，a.val2和a.key），然后我们再和 c 表 join 的时候，如果 c.key 与 a.key 或 b.key 相等，就会得到这样的结果：<code>NULL, NULL, NULL, c.val</code></p>
</li>
<li><p>具体实例</p>
<ol>
<li><p>获取已经分配班级的学生姓名。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/Cic2jbAFD9.png?imageslim" alt="mark"></p>
</li>
<li><p>获取尚未分配班级的学生姓名。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/4DEbE8ChaE.png?imageslim" alt="mark"></p>
</li>
<li><p>LEFT  SEMI  JOIN是IN/EXISTS的高效实现。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/35EDK1Cm5i.png?imageslim" alt="mark"></p>
</li>
</ol>
</li>
</ul>
<h2 id="Hive-Shell参数"><a href="#Hive-Shell参数" class="headerlink" title="Hive Shell参数"></a>Hive Shell参数</h2><h3 id="Hive命令行"><a href="#Hive命令行" class="headerlink" title="Hive命令行"></a>Hive命令行</h3><ul>
<li>语法结构<ul>
<li><code>hive [-hiveconf x=y]* [&lt;-i filename&gt;]* [&lt;-f filename&gt;|&lt;-e query-string&gt;][-S]</code></li>
</ul>
</li>
<li>说明：<ol>
<li>-i 从文件初始化HQL。</li>
<li>-e从命令行执行指定的HQL </li>
<li>-f 执行HQL脚本 </li>
<li>-v 输出执行的HQL语句到控制台 </li>
<li>-p <port> connect to Hive Server on port number </port></li>
<li>-hiveconf x=y Use this to set hive/hadoop configuration variables.</li>
</ol>
</li>
<li>具体实例</li>
</ul>
<ol>
<li><p>运行一个查询。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/DIg4Ca6B5d.png?imageslim" alt="mark"></p>
</li>
<li><p>运行一个文件。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/lELDEe7cf7.png?imageslim" alt="mark"></p>
</li>
<li><p>运行参数文件。</p>
<p><img src="http://ou9crezlk.bkt.clouddn.com/blog/180307/HD7BiB7H6d.png?imageslim" alt="mark"></p>
</li>
</ol>
<h3 id="Hive参数配置方式"><a href="#Hive参数配置方式" class="headerlink" title="Hive参数配置方式"></a>Hive参数配置方式</h3><ul>
<li>Hive参数大全：<ul>
<li><code>https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties</code></li>
</ul>
</li>
<li>开发Hive应用时，不可避免地需要设定Hive的参数。设定Hive的参数可以调优HQL代码的执行效率，或帮助定位问题。然而实践中经常遇到的一个问题是，为什么设定的参数没有起作用？这通常是错误的设定方式导致的。</li>
<li>对于一般参数，有以下三种设定方式：<ul>
<li>配置文件 </li>
<li>命令行参数  </li>
<li>参数声明 </li>
</ul>
</li>
<li>配置文件：Hive的配置文件包括<ul>
<li>用户自定义配置文件：$HIVE_CONF_DIR/hive-site.xml </li>
<li>默认配置文件：$HIVE_CONF_DIR/hive-default.xml </li>
</ul>
</li>
<li>用户自定义配置会覆盖默认配置。</li>
<li>另外，Hive也会读入Hadoop的配置，因为Hive是作为Hadoop的客户端启动的，Hive的配置会覆盖Hadoop的配置。</li>
<li>配置文件的设定对本机启动的所有Hive进程都有效。</li>
<li>命令行参数：启动Hive（客户端或Server方式）时，可以在命令行添加<code>-hiveconf param=value</code>来设定参数，例如：<ul>
<li><code>bin/hive -hiveconf hive.root.logger=INFO,console</code></li>
</ul>
</li>
<li>这一设定对本次启动的Session（对于Server方式启动，则是所有请求的Sessions）有效。</li>
<li>参数声明：可以在HQL中使用SET关键字设定参数，例如：<ul>
<li><code>set mapred.reduce.tasks=100;</code></li>
</ul>
</li>
<li>这一设定的作用域也是session级的。</li>
<li>上述三种设定方式的优先级依次递增。即参数声明覆盖命令行参数，命令行参数覆盖配置文件设定。注意某些系统级的参数，例如log4j相关的设定，必须用前两种方式设定，因为那些参数的读取在Session建立以前已经完成了。</li>
</ul>
<h2 id="Hive函数"><a href="#Hive函数" class="headerlink" title="Hive函数"></a>Hive函数</h2><h3 id="内置运算符"><a href="#内置运算符" class="headerlink" title="内置运算符"></a>内置运算符</h3><p>内容较多，见《Hive官方文档》</p>
<h3 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h3><p>内容较多，见《Hive官方文档》<br><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</a></p>
<ul>
<li><p>测试各种内置函数的快捷方法：</p>
<ol>
<li>创建一个dual表</li>
</ol>
<p>create table dual(id string);</p>
<ol>
<li>load一个文件（一行，一个空格）到dual表</li>
<li>select substr(‘angelababy’,2,3) from dual;</li>
</ol>
</li>
</ul>
<h3 id="Hive自定义函数和Transform"><a href="#Hive自定义函数和Transform" class="headerlink" title="Hive自定义函数和Transform"></a>Hive自定义函数和Transform</h3><ul>
<li>当Hive提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（UDF：user-defined function）。</li>
</ul>
<h4 id="自定义函数类别"><a href="#自定义函数类别" class="headerlink" title="自定义函数类别"></a>自定义函数类别</h4><ul>
<li>UDF  作用于单个数据行，产生一个数据行作为输出。（数学函数，字符串函数）</li>
<li>UDAF（用户定义聚集函数）：接收多个输入数据行，并产生一个输出数据行。（count，max）</li>
</ul>
<h4 id="UDF开发实例"><a href="#UDF开发实例" class="headerlink" title="UDF开发实例"></a>UDF开发实例</h4><ul>
<li>简单UDF示例</li>
</ul>
<ol>
<li><p>先开发一个java类，继承UDF，并重载evaluate方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.bigdata.udf</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Lower</span> <span class="keyword">extends</span> <span class="title">UDF</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Text <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> Text s)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(s==<span class="keyword">null</span>)&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Text(s.toString().toLowerCase());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打成jar包上传到服务器</p>
</li>
<li><p>将jar包添加到hive的classpath</p>
<ul>
<li><code>hive&gt;add JAR /home/hadoop/udf.jar;</code></li>
</ul>
</li>
<li><p>创建临时函数与开发好的java class关联</p>
<ul>
<li><code>Hive&gt;create temporary function tolowercase as &#39;cn.itcast.bigdata.udf.ToProvince&#39;;</code></li>
</ul>
</li>
</ol>
<p>5、即可在hql中使用自定义的函数strip </p>
<h4 id="Transform实现"><a href="#Transform实现" class="headerlink" title="Transform实现"></a>Transform实现</h4><ul>
<li><p>Hive的 TRANSFORM 关键字提供了在SQL中调用自写脚本的功能</p>
</li>
<li><p>适合实现Hive中没有的功能又不想写UDF的情况</p>
</li>
<li><p>使用示例1：下面这句sql就是借用了weekday_mapper.py对数据进行了处理.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> u_data_new (</span><br><span class="line">  movieid <span class="built_in">INT</span>,</span><br><span class="line">  rating <span class="built_in">INT</span>,</span><br><span class="line">  <span class="keyword">weekday</span> <span class="built_in">INT</span>,</span><br><span class="line">  userid <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line">add FILE weekday_mapper.py;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> u_data_new</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  TRANSFORM (movieid , rate, timestring,uid)</span><br><span class="line">  <span class="keyword">USING</span> <span class="string">'python weekday_mapper.py'</span></span><br><span class="line">  <span class="keyword">AS</span> (movieid, rating, <span class="keyword">weekday</span>,userid)</span><br><span class="line"><span class="keyword">FROM</span> t_rating;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中weekday_mapper.py内容如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">  line = line.strip()</span><br><span class="line">  movieid, rating, unixtime,userid = line.split(<span class="string">'\t'</span>)</span><br><span class="line">  weekday = datetime.datetime.fromtimestamp(float(unixtime)).isoweekday()</span><br><span class="line">  <span class="keyword">print</span> <span class="string">'\t'</span>.join([movieid, rating, str(weekday),userid])</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Hive实战"><a href="#Hive实战" class="headerlink" title="Hive实战"></a>Hive实战</h2><h3 id="Hive-实战案例1——数据ETL"><a href="#Hive-实战案例1——数据ETL" class="headerlink" title="Hive 实战案例1——数据ETL"></a>Hive 实战案例1——数据ETL</h3><h4 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h4><ul>
<li><p>对web点击流日志基础数据表进行etl（按照仓库模型设计）</p>
</li>
<li><p>按各时间维度统计来源域名top10</p>
</li>
<li><p>已有数据表 “t_orgin_weblog” ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------------+------------+----------+--+</span><br><span class="line">|     col_name     | data_type  | comment  |</span><br><span class="line">+------------------+------------+----------+--+</span><br><span class="line">| valid            | string     |          |</span><br><span class="line">| remote_addr      | string     |          |</span><br><span class="line">| remote_user      | string     |          |</span><br><span class="line">| time_local       | string     |          |</span><br><span class="line">| request          | string     |          |</span><br><span class="line">| status           | string     |          |</span><br><span class="line">| body_bytes_sent  | string     |          |</span><br><span class="line">| http_referer     | string     |          |</span><br><span class="line">| http_user_agent  | string     |          |</span><br><span class="line">+------------------+------------+----------+--+</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| true|1.162.203.134| - | 18/Sep/2013:13:47:35| /images/my.jpg                        | 200| 19939 | &quot;http://www.angularjs.cn/A0d9&quot;                      | &quot;Mozilla/5.0 (Windows   |</span><br><span class="line"></span><br><span class="line">| true|1.202.186.37 | - | 18/Sep/2013:15:39:11| /wp-content/uploads/2013/08/windjs.png| 200| 34613 | &quot;http://cnodejs.org/topic/521a30d4bee8d3cb1272ac0f&quot; | &quot;Mozilla/5.0 (Macintosh;|</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="实现步骤："><a href="#实现步骤：" class="headerlink" title="实现步骤："></a>实现步骤：</h4><ol>
<li><p>对原始数据进行抽取转换</p>
<ul>
<li><p>将来访url分离出<code>host  path  query  query_id</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> t_etl_referurl;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_etl_referurl <span class="keyword">as</span></span><br><span class="line"><span class="keyword">SELECT</span> a.,b.</span><br><span class="line"><span class="keyword">FROM</span> t_orgin_weblog a LATERAL <span class="keyword">VIEW</span> parse_url_tuple(regexp_replace(http_referer, <span class="string">"\""</span>, <span class="string">""</span>), <span class="string">'HOST'</span>, <span class="string">'PATH'</span>,<span class="string">'QUERY'</span>, <span class="string">'QUERY:id'</span>) b <span class="keyword">as</span> host, <span class="keyword">path</span>, <span class="keyword">query</span>, query_id</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>从前述步骤进一步分离出日期时间形成ETL明细表“t_etl_detail”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> t_etl_detail;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_etl_detail <span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> b.*,<span class="keyword">substring</span>(time_local,<span class="number">0</span>,<span class="number">11</span>) <span class="keyword">as</span> daystr,</span><br><span class="line"><span class="keyword">substring</span>(time_local,<span class="number">13</span>) <span class="keyword">as</span> tmstr,</span><br><span class="line"><span class="keyword">substring</span>(time_local,<span class="number">4</span>,<span class="number">3</span>) <span class="keyword">as</span> <span class="keyword">month</span>,</span><br><span class="line"><span class="keyword">substring</span>(time_local,<span class="number">0</span>,<span class="number">2</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line"><span class="keyword">substring</span>(time_local,<span class="number">13</span>,<span class="number">2</span>) <span class="keyword">as</span> <span class="keyword">hour</span></span><br><span class="line"><span class="keyword">from</span> t_etl_referurl b;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对etl数据进行分区(包含所有数据的结构化信息)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> t_etl_detail_prt;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_etl_detail_prt(</span><br><span class="line">valid                   <span class="keyword">string</span>,</span><br><span class="line">remote_addr            <span class="keyword">string</span>,</span><br><span class="line">remote_user            <span class="keyword">string</span>,</span><br><span class="line">time_local               <span class="keyword">string</span>,</span><br><span class="line">request                 <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">status</span>                  <span class="keyword">string</span>,</span><br><span class="line">body_bytes_sent         <span class="keyword">string</span>,</span><br><span class="line">http_referer             <span class="keyword">string</span>,</span><br><span class="line">http_user_agent         <span class="keyword">string</span>,</span><br><span class="line">host                   <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">path</span>                   <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">query</span>                  <span class="keyword">string</span>,</span><br><span class="line">query_id               <span class="keyword">string</span>,</span><br><span class="line">daystr                 <span class="keyword">string</span>,</span><br><span class="line">tmstr                  <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">month</span>                  <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">day</span>                    <span class="keyword">string</span>,</span><br><span class="line"><span class="keyword">hour</span>                   <span class="keyword">string</span>) </span><br><span class="line">partitioned <span class="keyword">by</span> (mm <span class="keyword">string</span>,dd <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>导入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> t_etl_detail_prt <span class="keyword">partition</span>(mm=<span class="string">'Sep'</span>,dd=<span class="string">'18'</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_etl_detail <span class="keyword">where</span> daystr=<span class="string">'18/Sep/2013'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> t_etl_detail_prt <span class="keyword">partition</span>(mm=<span class="string">'Sep'</span>,dd=<span class="string">'19'</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_etl_detail <span class="keyword">where</span> daystr=<span class="string">'19/Sep/2013'</span>;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>分个时间维度统计各referer_host的访问次数并排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_refer_host_visit_top_tmp <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> referer_host,<span class="keyword">count</span>(*) <span class="keyword">as</span> counts,mm,dd,hh <span class="keyword">from</span> t_display_referer_counts <span class="keyword">group</span> <span class="keyword">by</span> hh,dd,mm,referer_host <span class="keyword">order</span> <span class="keyword">by</span> hh <span class="keyword">asc</span>,dd <span class="keyword">asc</span>,mm <span class="keyword">asc</span>,counts <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>来源访问次数topn各时间维度URL</p>
<ul>
<li><p>取各时间维度的referer_host访问次数topn</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> (<span class="keyword">select</span> referer_host,counts,<span class="keyword">concat</span>(hh,dd),row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">concat</span>(hh,dd) <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">concat</span>(hh,dd) <span class="keyword">asc</span>) <span class="keyword">as</span> od <span class="keyword">from</span> t_refer_host_visit_top_tmp) t <span class="keyword">where</span> od&lt;=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="Hive实战案例3——级联求和"><a href="#Hive实战案例3——级联求和" class="headerlink" title="Hive实战案例3——级联求和"></a>Hive实战案例3——级联求和</h3><h4 id="需求：-1"><a href="#需求：-1" class="headerlink" title="需求："></a>需求：</h4><ul>
<li><p>有如下访客访问次数统计表 t_access_times</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">访客	月份	访问次数</span><br><span class="line">A	2015-01	5</span><br><span class="line">A	2015-01	15</span><br><span class="line">B	2015-01	5</span><br><span class="line">A	2015-01	8</span><br><span class="line">B	2015-01	25</span><br><span class="line">A	2015-01	5</span><br><span class="line">A	2015-02	4</span><br><span class="line">A	2015-02	6</span><br><span class="line">B	2015-02	10</span><br><span class="line">B	2015-02	5</span><br><span class="line">……	……	……</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要输出报表：t_access_times_accumulate</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">访客	月份	月访问总计	累计访问总计</span><br><span class="line">A	2015-01	33	33</span><br><span class="line">A	2015-02	10	43</span><br><span class="line">…….	…….	…….	…….</span><br><span class="line">B	2015-01	30	30</span><br><span class="line">B	2015-02	15	45</span><br><span class="line">…….	…….	…….	…….</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h4><ul>
<li><p>可以用一个hql语句即可实现：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> A.username,A.month,<span class="keyword">max</span>(A.salary) <span class="keyword">as</span> salary,<span class="keyword">sum</span>(B.salary) <span class="keyword">as</span> accumulate</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> username,<span class="keyword">month</span>,<span class="keyword">sum</span>(salary) <span class="keyword">as</span> salary <span class="keyword">from</span> t_access_times <span class="keyword">group</span> <span class="keyword">by</span> username,<span class="keyword">month</span>) A </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> </span><br><span class="line">(<span class="keyword">select</span> username,<span class="keyword">month</span>,<span class="keyword">sum</span>(salary) <span class="keyword">as</span> salary <span class="keyword">from</span> t_access_times <span class="keyword">group</span> <span class="keyword">by</span> username,<span class="keyword">month</span>) B</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">A.username=B.username</span><br><span class="line"><span class="keyword">where</span> B.month &lt;= A.month</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> A.username,A.month</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> A.username,A.month;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weixin.png" alt="Wei.Cao 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zhifubao.png" alt="Wei.Cao 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Wei.Cao
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/2017/06/22/Hive学习/" title="Hive学习">http://yoursite.com/2017/06/22/Hive学习/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hadoop/" rel="tag"># Hadoop</a>
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Hive/" rel="tag"># Hive</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/21/Let's Encrypt 使用教程，免费的 SSL 证书/" rel="next" title="Let's Encrypt 使用教程，免费的 SSL 证书">
                <i class="fa fa-chevron-left"></i> Let's Encrypt 使用教程，免费的 SSL 证书
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/26/hive问题集/" rel="prev" title="hive问题集">
                hive问题集 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/596cd3e8d520e.png"
                alt="Wei.Cao" />
            
              <p class="site-author-name" itemprop="name">Wei.Cao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">107</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1614642&auto=1&height=66"></iframe>          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive基本概念"><span class="nav-number">1.</span> <span class="nav-text">Hive基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive简介"><span class="nav-number">1.1.</span> <span class="nav-text">Hive简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是Hive"><span class="nav-number">1.1.1.</span> <span class="nav-text">什么是Hive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么使用Hive"><span class="nav-number">1.1.2.</span> <span class="nav-text">为什么使用Hive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive的特点"><span class="nav-number">1.1.3.</span> <span class="nav-text">Hive的特点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive架构"><span class="nav-number">1.2.</span> <span class="nav-text">Hive架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#架构图"><span class="nav-number">1.2.1.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本组成"><span class="nav-number">1.2.2.</span> <span class="nav-text">基本组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#各组件的基本功能"><span class="nav-number">1.2.3.</span> <span class="nav-text">各组件的基本功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive与Hadoop的关系"><span class="nav-number">1.3.</span> <span class="nav-text">Hive与Hadoop的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive与传统数据库对比"><span class="nav-number">1.4.</span> <span class="nav-text">Hive与传统数据库对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive的数据存储"><span class="nav-number">1.5.</span> <span class="nav-text">Hive的数据存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive基本操作"><span class="nav-number">2.</span> <span class="nav-text">Hive基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方式"><span class="nav-number">2.1.</span> <span class="nav-text">使用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive交互shell"><span class="nav-number">2.1.1.</span> <span class="nav-text">Hive交互shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive-thrift服务"><span class="nav-number">2.1.2.</span> <span class="nav-text">Hive thrift服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive命令"><span class="nav-number">2.1.3.</span> <span class="nav-text">Hive命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DDL操作"><span class="nav-number">2.2.</span> <span class="nav-text">DDL操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建表"><span class="nav-number">2.2.1.</span> <span class="nav-text">创建表</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#建表语法"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">建表语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#具体实例"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">具体实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改表"><span class="nav-number">2.2.2.</span> <span class="nav-text">修改表</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#增加-删除分区"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">增加/删除分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重命名表"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">重命名表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#增加-更新列"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">增加/更新列</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示命令"><span class="nav-number">2.2.3.</span> <span class="nav-text">显示命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DML操作"><span class="nav-number">2.3.</span> <span class="nav-text">DML操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Load"><span class="nav-number">2.3.1.</span> <span class="nav-text">Load</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Insert"><span class="nav-number">2.3.2.</span> <span class="nav-text">Insert</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SELECT"><span class="nav-number">2.3.3.</span> <span class="nav-text">SELECT</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-Join"><span class="nav-number">2.4.</span> <span class="nav-text">Hive Join</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#只支持等值join"><span class="nav-number">2.4.1.</span> <span class="nav-text">只支持等值join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可以-join-多于-2-个表。"><span class="nav-number">2.4.2.</span> <span class="nav-text">可以 join 多于 2 个表。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#join-时，每次-map-reduce-任务的逻辑："><span class="nav-number">2.4.3.</span> <span class="nav-text">join 时，每次 map/reduce 任务的逻辑：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LEFT，RIGHT-和-FULL-OUTER-关键字用于处理-join-中空记录的情况"><span class="nav-number">2.4.4.</span> <span class="nav-text">LEFT，RIGHT 和 FULL OUTER 关键字用于处理 join 中空记录的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Join-发生在-WHERE-子句之前。"><span class="nav-number">2.4.5.</span> <span class="nav-text">Join 发生在 WHERE 子句之前。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Join-是不能交换位置的。"><span class="nav-number">2.4.6.</span> <span class="nav-text">Join 是不能交换位置的。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive-Shell参数"><span class="nav-number">3.</span> <span class="nav-text">Hive Shell参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive命令行"><span class="nav-number">3.1.</span> <span class="nav-text">Hive命令行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive参数配置方式"><span class="nav-number">3.2.</span> <span class="nav-text">Hive参数配置方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive函数"><span class="nav-number">4.</span> <span class="nav-text">Hive函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内置运算符"><span class="nav-number">4.1.</span> <span class="nav-text">内置运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内置函数"><span class="nav-number">4.2.</span> <span class="nav-text">内置函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive自定义函数和Transform"><span class="nav-number">4.3.</span> <span class="nav-text">Hive自定义函数和Transform</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义函数类别"><span class="nav-number">4.3.1.</span> <span class="nav-text">自定义函数类别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDF开发实例"><span class="nav-number">4.3.2.</span> <span class="nav-text">UDF开发实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Transform实现"><span class="nav-number">4.3.3.</span> <span class="nav-text">Transform实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive实战"><span class="nav-number">5.</span> <span class="nav-text">Hive实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-实战案例1——数据ETL"><span class="nav-number">5.1.</span> <span class="nav-text">Hive 实战案例1——数据ETL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#需求："><span class="nav-number">5.1.1.</span> <span class="nav-text">需求：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤："><span class="nav-number">5.1.2.</span> <span class="nav-text">实现步骤：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive实战案例3——级联求和"><span class="nav-number">5.2.</span> <span class="nav-text">Hive实战案例3——级联求和</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#需求：-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">需求：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤"><span class="nav-number">5.2.2.</span> <span class="nav-text">实现步骤</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wei.Cao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: '1498103435000', 
            owner: 'huaxiaowei',
            repo: 'gitment-comments',
            
            lang: "zh-Hans# Force language, or auto switch by theme" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'a5317db783a77a762d0b32c444be681f8a55daed',
            
                client_id: 'e725b4cc6235cd482ba5'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
